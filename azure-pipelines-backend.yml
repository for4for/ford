trigger:
  branches:
    include:
    - main
  paths:
    include:
    - backend/*
    - azure-pipelines-backend.yml

resources:
- repo: self

variables:
  tag: '$(Build.BuildId)'
  repository: bayiler.backend
  subscription: svc

stages:
- stage: BuildAndDeploy
  displayName: Build and Deploy Backend
  condition: eq(variables['Build.SourceBranch'], 'refs/heads/main')
  variables:
  - group: prod-variables
  jobs:
  - job: Build
    displayName: Build Backend Image
    pool:
      vmImage: ubuntu-latest
    steps:
    - task: AzureKeyVault@2
      inputs:
        azureSubscription: $(subscription)
        KeyVaultName: 'progin-kv'
        SecretsFilter: '*'
        RunAsPreJob: true
    - task: Docker@2
      displayName: Build and Push Backend Image
      inputs:
        containerRegistry: bayileracr
        command: buildAndPush
        buildContext: '$(Build.SourcesDirectory)/backend'
        dockerfile: '$(Build.SourcesDirectory)/backend/Dockerfile'
        repository: $(repository)
        tags: |
          prod-latest
          prod-$(tag)
  - deployment: Deploy
    displayName: Deploy Backend
    dependsOn: Build
    pool:
      vmImage: ubuntu-latest
    environment: prod
    strategy:
      runOnce:
        deploy:
          steps:
          - task: AzureKeyVault@2
            inputs:
              azureSubscription: $(subscription)
              KeyVaultName: 'progin-kv'
              SecretsFilter: '*'
              RunAsPreJob: true
          - task: AzureCLI@2
            displayName: Deploy to Container Apps
            inputs:
              azureSubscription: $(subscription)
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                echo "Deploying Backend to Azure Container Apps..."
                
                # Container App'i g√ºncelle (image + env vars)
                az containerapp update \
                  --name bayiler-backend \
                  --resource-group Programatik-Prod \
                  --image bayileracr.azurecr.io/$(repository):prod-$(tag) \
                  --set-env-vars \
                    DATABASE_URL="$(BAYILER-DATABASE-URL)" \
                    SECRET_KEY="$(BAYILER-SECRET-KEY)" \
                    DEBUG="false" \
                    ALLOWED_HOSTS="bayiler-backend.blackfield-af7b499c.westeurope.azurecontainerapps.io" \
                    CORS_ALLOWED_ORIGINS="https://bayiler.intechno360.com" \
                    CSRF_TRUSTED_ORIGINS="https://bayiler.intechno360.com,https://bayiler-backend.blackfield-af7b499c.westeurope.azurecontainerapps.io" \
                    AZURE_STORAGE_ACCOUNT_NAME="$(BAYILER-AZURE-STORAGE-ACCOUNT-NAME)" \
                    AZURE_STORAGE_ACCOUNT_KEY="$(BAYILER-AZURE-STORAGE-ACCOUNT-KEY)" \
                    AZURE_STORAGE_CONTAINER="$(BAYILER-AZURE-STORAGE-CONTAINER)" \
                    EMAIL_BACKEND="$(BAYILER-EMAIL-BACKEND)" \
                    EMAIL_HOST="$(BAYILER-EMAIL-HOST)" \
                    EMAIL_PORT="$(BAYILER-EMAIL-PORT)" \
                    EMAIL_USE_TLS="$(BAYILER-EMAIL-USE-TLS)" \
                    EMAIL_HOST_USER="$(BAYILER-EMAIL-HOST-USER)" \
                    EMAIL_HOST_PASSWORD="$(BAYILER-EMAIL-HOST-PASSWORD)" \
                    DEFAULT_FROM_EMAIL="$(BAYILER-DEFAULT-FROM-EMAIL)" \
                    FRONTEND_URL="$(BAYILER-FRONTEND-URL)"
                
                echo "Updating Container App resources..."
                az containerapp update \
                  --name bayiler-backend \
                  --resource-group Programatik-Prod \
                  --container-name bayiler-backend \
                  --cpu 4 \
                  --memory 8Gi \
                  --min-replicas 1 \
                  --max-replicas 10
                
                echo "Running database migrations..."
                az containerapp exec \
                  --name bayiler-backend \
                  --resource-group Programatik-Prod \
                  --command "python manage.py migrate --noinput"
                
                echo "Collecting static files..."
                az containerapp exec \
                  --name bayiler-backend \
                  --resource-group Programatik-Prod \
                  --command "python manage.py collectstatic --noinput"
                
                echo "Backend deployment completed!"
          

